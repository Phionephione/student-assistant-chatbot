{% extends "base.html" %}

{% block content %}
<div class="chat-container">
    <h1>Welcome, {{ name }}! Ask me anything.</h1>
    <a href="{{ url_for('logout') }}">Logout</a>
    <a href="{{ url_for('download_chat') }}">Download Chat History</a>
    <div id="chat-log">
        <!-- Chat messages will be displayed here -->
    </div>
    <div class="input-area">
        <input type="text" id="user-input" placeholder="Type your question...">
        <button id="start-recording">Start Recording</button>
        <button id="send-button">Send</button>
    </div>
</div>

<script>
    // All of your JavaScript code remains exactly the same here
    const chatLog = document.getElementById("chat-log");
    const userInput = document.getElementById("user-input");
    const sendButton = document.getElementById("send-button");
    const startRecordingButton = document.getElementById("start-recording");
    let recognition;

    if ('webkitSpeechRecognition' in window) {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = true;
        recognition.lang = 'en-US';

        recognition.onstart = function() {
            startRecordingButton.textContent = 'Recording...';
        };

        recognition.onresult = function(event) {
            let final_transcript = '';
            let interim_transcript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    final_transcript += event.results[i][0].transcript;
                } else {
                    interim_transcript = event.results[i][0].transcript;
                }
            }
            userInput.value = final_transcript + interim_transcript;
        };

        recognition.onerror = function(event) {
            console.error('Speech recognition error:', event.error);
            startRecordingButton.textContent = 'Start Recording';
        };

        recognition.onend = function() {
            startRecordingButton.textContent = 'Start Recording';
        };

        startRecordingButton.addEventListener('click', function() {
            if (startRecordingButton.textContent === 'Start Recording') {
                userInput.value = "";
                recognition.start();
            } else {
                recognition.stop();
            }
        });

    } else {
        startRecordingButton.disabled = true;
        startRecordingButton.textContent = 'Speech Recognition Not Supported';
    }

    sendButton.addEventListener("click", sendMessage);

    userInput.addEventListener("keydown", function(event) {
        if (event.key === "Enter") {
            sendMessage();
        }
    });

    function sendMessage() {
        const message = userInput.value;
        if (message.trim() === "") return;

        appendMessage("user", message);
        userInput.value = "";

        fetch("/get_response", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
            },
            body: "user_input=" + encodeURIComponent(message),
        })
        .then(response => response.json())
        .then(data => {
            appendMessage("bot", data.response);
        })
        .catch(error => {
            console.error("Error:", error);
            appendMessage("bot", "Sorry, a network error occurred.");
        });
    }

    function appendMessage(sender, message) {
        const messageDiv = document.createElement("div");
        messageDiv.classList.add("message", sender);
        messageDiv.textContent = message;
        chatLog.appendChild(messageDiv);
        chatLog.scrollTop = chatLog.scrollHeight;
    }
</script>
{% endblock %}